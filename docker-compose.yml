version: '3.8'

services:
  # ========================================
  # Nginx - Reverse Proxy & Load Balancer
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: xingu-nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - web
      - auth-service
      - template-service
      - game-service
      - room-service
      - ws-service
      - result-service
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # PostgreSQL - Main Database
  # ========================================
  postgres:
    image: postgres:17-alpine
    container_name: xingu-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: xingu
    ports:
      - '5432:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Redis - Session Store & Cache
  # ========================================
  redis:
    image: redis:alpine
    container_name: xingu-redis
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Next.js Web App
  # ========================================
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile.optimized
    container_name: xingu-web
    environment:
      - NODE_ENV=production
      - AUTH_SERVICE_URL=http://auth-service:3001
      - TEMPLATE_SERVICE_URL=http://template-service:3002
      - GAME_SERVICE_URL=http://game-service:3003
      - ROOM_SERVICE_URL=http://room-service:3004
      - WS_SERVICE_URL=http://ws-service:3005
      - RESULT_SERVICE_URL=http://result-service:3006
      - NEXT_PUBLIC_API_URL=http://localhost
      - NEXT_PUBLIC_WS_URL=http://localhost/ws
    ports:
      - '3000:3000'
    depends_on:
      - auth-service
      - template-service
      - game-service
      - room-service
      - ws-service
      - result-service
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Auth Service (NestJS)
  # ========================================
  auth-service:
    build:
      context: .
      dockerfile: ./apps/auth-service/Dockerfile.optimized
    container_name: xingu-auth-service
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/xingu?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - JWT_ACCESS_EXPIRY=15m
      - JWT_REFRESH_EXPIRY=7d
      - CORS_ORIGIN=http://localhost
    ports:
      - '3001:3001'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Template Service (Express) - Public game templates
  # ========================================
  template-service:
    build:
      context: .
      dockerfile: ./apps/template-service/Dockerfile.optimized
    container_name: xingu-template-service
    environment:
      - NODE_ENV=production
      - PORT=3002
      - REDIS_URL=redis://redis:6379
      - CORS_ORIGIN=http://localhost
    ports:
      - '3002:3002'
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3002/health']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Game Service (Express) - My games CRUD
  # ========================================
  game-service:
    build:
      context: .
      dockerfile: ./apps/game-service/Dockerfile.optimized
    container_name: xingu-game-service
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/xingu?schema=public
      - REDIS_URL=redis://redis:6379
      - CORS_ORIGIN=http://localhost
    ports:
      - '3003:3003'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3003/health']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Room Service (Express) - Room & PIN management
  # ========================================
  room-service:
    build:
      context: .
      dockerfile: ./apps/room-service/Dockerfile.optimized
    container_name: xingu-room-service
    environment:
      - NODE_ENV=production
      - PORT=3004
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/xingu?schema=public
      - REDIS_URL=redis://redis:6379
      - CORS_ORIGIN=http://localhost
    ports:
      - '3004:3004'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3004/health']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # WebSocket Service (Socket.io) - Real-time gameplay
  # ========================================
  ws-service:
    build:
      context: .
      dockerfile: ./apps/ws-service/Dockerfile.optimized
    container_name: xingu-ws-service
    environment:
      - NODE_ENV=production
      - PORT=3005
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/xingu?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - CORS_ORIGIN=http://localhost
    ports:
      - '3005:3005'
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - xingu-network
    restart: unless-stopped

  # ========================================
  # Result Service (Express) - Game results & statistics
  # ========================================
  result-service:
    build:
      context: .
      dockerfile: ./apps/result-service/Dockerfile.optimized
    container_name: xingu-result-service
    environment:
      - NODE_ENV=production
      - PORT=3006
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/xingu?schema=public
      - REDIS_URL=redis://redis:6379
      - CORS_ORIGIN=http://localhost
    ports:
      - '3006:3006'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3006/health']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xingu-network
    restart: unless-stopped

# ========================================
# Networks
# ========================================
networks:
  xingu-network:
    driver: bridge

# ========================================
# Volumes
# ========================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
